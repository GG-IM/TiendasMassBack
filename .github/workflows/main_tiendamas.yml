name: Build and Deploy Node.js App to Azure Web App - TIENDAMAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm install

      - name: Verificar que node_modules existe
        run: |
          if [ ! -d node_modules ]; then
            echo "❌ node_modules no fue generado. Falló npm install."
            exit 1
          else
            echo "✅ node_modules presente."
          fi

      - name: Build and capture logs
        run: |
          npm run build > build.log 2>&1 || (echo "❌ Falló el build:" && cat build.log && exit 1)

      - name: Verificar que dist/app.js existe
        run: |
          if [ ! -f dist/app.js ]; then
            echo "❌ dist/app.js no fue generado. Revisa tu build."
            exit 1
          else
            echo "✅ dist/app.js encontrado."
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: |
            .
            !node_modules/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Verificar contenido de dist
        run: ls -la dist

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_62D9787558B04305B95059792FC4BEE9 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_AFC2A62D6F68457AA53DCAF6B66C528F }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_239FA8C2851842228653F263DA267F80 }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'TIENDAMAS'
          slot-name: 'Production'
          package: .
          
      - name: Verificar estado de la app (health check con reintentos)
        run: |
          echo "⏳ Esperando hasta 2 minutos por el /api/health..."
      
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tiendamas-g7cbc7hgchbccygs.azurewebsites.net/api/health)
            if [ "$STATUS" -eq 200 ]; then
              echo "✅ La app respondió correctamente: $STATUS"
              exit 0
            else
              echo "⏳ Intento $i: La app aún no responde (HTTP $STATUS). Esperando 10s..."
              sleep 10
            fi
          done
      
          echo "❌ La app no respondió exitosamente en el tiempo esperado."
          exit 1
