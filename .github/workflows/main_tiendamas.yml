name: Build and Deploy Node.js App to Azure Web App - TIENDAMAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm install

      - name: Verificar que node_modules existe
        run: |
          if [ ! -d node_modules ]; then
            echo "‚ùå node_modules no fue generado. Fall√≥ npm install."
            exit 1
          else
            echo "‚úÖ node_modules presente."
          fi

      - name: Build and capture logs
        run: |
          npm run build > build.log 2>&1 || (echo "‚ùå Fall√≥ el build:" && cat build.log && exit 1)

      - name: Verificar que dist/app.js existe
        run: |
          if [ ! -f dist/app.js ]; then
            echo "‚ùå dist/app.js no fue generado. Revisa tu build."
            exit 1
          else
            echo "‚úÖ dist/app.js encontrado."
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: |
            .
            !node_modules/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Verificar contenido de dist
        run: ls -la dist

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_62D9787558B04305B95059792FC4BEE9 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_AFC2A62D6F68457AA53DCAF6B66C528F }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_239FA8C2851842228653F263DA267F80 }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'TIENDAMAS'
          slot-name: 'Production'
          package: .
          
      - name: Verificar estado de la app (health check)
        run: |
          echo "‚è≥ Esperando 20 segundos para que la app arranque..."
          sleep 20
          echo "üîç Verificando /api/health..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://tiendamas-g7cbc7hgchbccygs.azurewebsites.net/api/health)
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå Health check fall√≥. C√≥digo HTTP: $STATUS"
            exit 1
          else
            echo "‚úÖ Health check exitoso. La app est√° viva."
          fi
